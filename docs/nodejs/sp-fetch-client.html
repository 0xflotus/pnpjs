<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>@pnp - SharePoint Patterns and Practices JavaScript Libraries</title>
    <link rel="stylesheet" href="/pnpjs/css/highlightjs-github.css">
    <link rel="stylesheet" href="/pnpjs/css/site.css">
</head>

<body>
    <header>
        <div>
            <div class="logo">
                <img src="img/office365-header-icon.png" alt="Logo" />
            </div>
            <div class="pnp-title">
                <span id="headerText">
                    <a href="/pnpjs">SharePoint Patterns and Practices</a>
                </span>
                <span id="subheaderText">PnPjs: Client Side Libraries for Microsoft 365</span>
            </div>
        </div>
    </header>

    <nav id="breadcrumbs">
        <a href="/pnpjs">@pnp</a>&nbsp;&nbsp;&gt;&nbsp;&nbsp;<a href="/pnpjs/nodejs">nodejs</a>&nbsp;&nbsp;&gt;&nbsp;&nbsp;<a href="/pnpjs/nodejs/sp-fetch-client.html">sp fetch client</a>
    </nav>

    <article>
        <h1 id="pnpnodejsspfetchclient">@pnp/nodejs/spfetchclient <a class="permalink" href="#pnpnodejsspfetchclient" aria-hidden="true">#</a></h1>
<p>The SPFetchClient is used to authentication to SharePoint as a provider hosted add-in using a client and secret in nodejs. Remember it is not a good practive to expose client ids and secrets on the client and use of this class is intended for nodejs exclusively.</p>
<pre><code class="language-TypeScript"><span class="hljs-keyword">import</span> { SPFetchClient } <span class="hljs-keyword">from</span> <span class="hljs-string">"@pnp/nodejs"</span>;
<span class="hljs-keyword">import</span> { sp } <span class="hljs-keyword">from</span> <span class="hljs-string">"@pnp/sp"</span>;

sp.setup({
    sp: {
        fetchClientFactory: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SPFetchClient(<span class="hljs-string">"{site url}"</span>, <span class="hljs-string">"{client id}"</span>, <span class="hljs-string">"{client secret}"</span>);
        },
    },
});

<span class="hljs-comment">// execute a library request as normal</span>
sp.web.get().then(<span class="hljs-function"><span class="hljs-params">w</span> =&gt;</span> {

    <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(w, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>));

}).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {

    <span class="hljs-built_in">console</span>.error(e);
});
</code></pre>
<h2 id="set-authentication-environment">Set Authentication Environment <a class="permalink" href="#set-authentication-environment" aria-hidden="true">#</a></h2>
<p><em>Added in 1.1.2</em></p>
<p>For some areas such as Germany, China, and US Gov clouds you need to specifiy a different authentication url to the service. This is done by specifying the correct SPOAuthEnv enumeration to the SPFetchClient constructor. The options are listed below. If you are not sure which option to specify the default is likely OK.</p>
<ul>
<li>SPO : (default) for all *.sharepoint.com urls</li>
<li>China: for China hosted cloud</li>
<li>Germany: for Germany local cloud</li>
<li>USDef: USA Defense cloud</li>
<li>USGov: USA Government cloud</li>
</ul>
<pre><code class="language-TypeScript"><span class="hljs-keyword">import</span> { sp } <span class="hljs-keyword">from</span> <span class="hljs-string">"@pnp/sp"</span>;
<span class="hljs-keyword">import</span> { SPFetchClient, SPOAuthEnv } <span class="hljs-keyword">from</span> <span class="hljs-string">"@pnp/nodejs"</span>;

sp.setup({
    sp: {
        fetchClientFactory: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SPFetchClient(<span class="hljs-string">"{site url}"</span>, <span class="hljs-string">"{client id}"</span>, <span class="hljs-string">"{client secret}"</span>, SPOAuthEnv.China);
        },
    },
});
</code></pre>
<h2 id="set-realm">Set Realm <a class="permalink" href="#set-realm" aria-hidden="true">#</a></h2>
<p>In some cases automatically resolving the realm may not work. In this case you can set the realm parameter in the SPFetchClient constructor. You can determine the correct value for the realm by navigating to “https://{site name}-admin.sharepoint.com/_layouts/15/TA_AllAppPrincipals.aspx” and copying the GUID value that appears after the “@” - this is the realm id.</p>
<p><strong>As of version 1.1.2 the realm parameter is now the 5th parameter in the constructor.</strong></p>
<pre><code class="language-TypeScript"><span class="hljs-keyword">import</span> { sp } <span class="hljs-keyword">from</span> <span class="hljs-string">"@pnp/sp"</span>;
<span class="hljs-keyword">import</span> { SPFetchClient, SPOAuthEnv } <span class="hljs-keyword">from</span> <span class="hljs-string">"@pnp/nodejs"</span>;

sp.setup({
    sp: {
        fetchClientFactory: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SPFetchClient(<span class="hljs-string">"{site url}"</span>, <span class="hljs-string">"{client id}"</span>, <span class="hljs-string">"{client secret}"</span>, SPOAuthEnv.SPO, <span class="hljs-string">"{realm}"</span>);
        },
    },
});
</code></pre>
<h2 id="creating-a-client-id-and-secret">Creating a client id and secret <a class="permalink" href="#creating-a-client-id-and-secret" aria-hidden="true">#</a></h2>
<p>This section outlines how to register for a client id and secret for use in the above code.</p>
<h3 id="register-an-add-in">Register An Add-In <a class="permalink" href="#register-an-add-in" aria-hidden="true">#</a></h3>
<p>Before you can begin running tests you need to register a low-trust add-in with SharePoint. This is primarily designed for Office 365, but can work on-premises if you <a href="https://msdn.microsoft.com/en-us/library/office/dn155905.aspx">configure you farm accordingly</a>.</p>
<ol>
<li>Navigation to {site url}/_layouts/appregnew.aspx</li>
<li>Click “Generate” for both the Client Id and Secret values</li>
<li>Give you add-in a title, this can be anything but will let you locate it in the list of add-in permissions</li>
<li>Provide a fake value for app domain and redirect uri, you can use the values shown in the examples</li>
<li>Click “Create”</li>
<li>Copy the returned block of text containing the client id and secret as well as app name for your records and later in this article.</li>
</ol>
<h3 id="grant-your-add-in-permissions">Grant Your Add-In Permissions <a class="permalink" href="#grant-your-add-in-permissions" aria-hidden="true">#</a></h3>
<p>Now that we have created an add-in registration we need to tell SharePoint what permissions it can use. Due to an update in SharePoint Online you now have to <a href="https://msdn.microsoft.com/en-us/pnp_articles/how-to-provide-add-in-app-only-tenant-administrative-permissions-in-sharepoint-online">register add-ins with certain permissions in the admin site</a>.</p>
<ol>
<li>Navigate to {admin site url}/_layouts/appinv.aspx</li>
<li>Paste your client id from the above section into the Add Id box and click “Lookup”</li>
<li>You should see the information populated into the form from the last section, if not ensure you have the correct id value</li>
<li>Paste the below XML into the permissions request xml box and hit “Create”</li>
<li>You should get a confirmation message.</li>
</ol>
<pre><code class="language-XML">  <span class="hljs-tag">&lt;<span class="hljs-name">AppPermissionRequests</span> <span class="hljs-attr">AllowAppOnlyPolicy</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">AppPermissionRequest</span> <span class="hljs-attr">Scope</span>=<span class="hljs-string">"http://sharepoint/content/tenant"</span> <span class="hljs-attr">Right</span>=<span class="hljs-string">"FullControl"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">AppPermissionRequest</span> <span class="hljs-attr">Scope</span>=<span class="hljs-string">"http://sharepoint/social/tenant"</span> <span class="hljs-attr">Right</span>=<span class="hljs-string">"FullControl"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">AppPermissionRequest</span> <span class="hljs-attr">Scope</span>=<span class="hljs-string">"http://sharepoint/search"</span> <span class="hljs-attr">Right</span>=<span class="hljs-string">"QueryAsUserIgnoreAppPrincipal"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">AppPermissionRequests</span>&gt;</span>
</code></pre>
<p><strong>Note that the above XML will grant full tenant control, you should grant only those permissions necessary for your application</strong></p>

    </article>

    <footer>
        <div class="brand">© Microsoft 2018</div>
        <div class="call-to-action">Please <a href="https://github.com/pnp/pnpjs/issues/new?title=Documentation: nodejs\sp-fetch-client.html&body=Please describe how we can improve the doc page:">report documentation issues/suggestions</a> to help us improve!</div>
    </footer>
</body>

</html><img src="https://telemetry.sharepointpnp.com/@pnp/pnpjs/ghpages/nodejs/docs/sp-fetch-client" alt="spacer" />